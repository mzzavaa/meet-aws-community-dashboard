{{ define "main" }}
<div class="user-groups-page">
    {{ .Content }}
    
    <h1>AWS User Groups</h1>
    
    <div id="map" style="height: 500px;"></div>
    
    <div class="search-container">
        <input type="text" id="search-input" class="search-input" placeholder="Search by name, location, or category...">
        
        <div class="filters">
            <button class="filter-btn active" data-category="all">All Regions</button>
            <button class="filter-btn" data-category="North America">North America</button>
            <button class="filter-btn" data-category="Europe">Europe</button>
            <button class="filter-btn" data-category="Asia">Asia</button>
            <button class="filter-btn" data-category="South America">South America</button>
            <button class="filter-btn" data-category="Africa">Africa</button>
            <button class="filter-btn" data-category="Oceania">Oceania</button>
        </div>
    </div>
    
    <div id="groups-container" class="grid"></div>
    
    <div class="pagination" id="pagination"></div>
    
    <div id="loading" class="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading User Groups...
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the map
            const map = L.map('map').setView([20, 0], 2);
            
            // Add the tile layer (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Custom purple icon for markers
            const purpleIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
            
            // Use the CSV URL directly
            const groupsCSV = "/data/aws_user_groups.csv";
            console.log("Loading AWS User Groups from:", groupsCSV);
            
            // Load user groups data
            fetch(groupsCSV)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    // Parse CSV
                    const groups = parseCSV(csvText);
                    
                    // Hide loading indicator
                    document.getElementById('loading').style.display = 'none';
                    
                    // Create marker cluster group
                    const markerCluster = L.markerClusterGroup({
                        maxClusterRadius: 50,
                        spiderfyOnMaxZoom: true,
                        showCoverageOnHover: true,
                        zoomToBoundsOnClick: true,
                        iconCreateFunction: function(cluster) {
                            const count = cluster.getChildCount();
                            // Calculate color intensity based on count
                            let color;
                            if (count < 10) {
                                color = '#a166ff'; // Light purple
                            } else if (count < 25) {
                                color = '#8c52c7'; // Medium purple
                            } else if (count < 50) {
                                color = '#6a3d99'; // Darker purple
                            } else {
                                color = '#4a2a6b'; // Very dark purple
                            }
                            
                            return L.divIcon({
                                html: `<div style="background-color: ${color}; color: white; border-radius: 50%; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: bold;">${count}</div>`,
                                className: 'marker-cluster',
                                iconSize: L.point(40, 40)
                            });
                        }
                    });
                    
                    // Add markers to the cluster
                    groups.forEach(group => {
                        if (group.Latitude && group.Longitude) {
                            const marker = L.marker([group.Latitude, group.Longitude], { icon: purpleIcon });
                            
                            marker.bindPopup(`
                                <div class="map-popup">
                                    <div class="map-popup-header user-group-popup-header">
                                        <h3>${group.Name}</h3>
                                    </div>
                                    <div class="map-popup-content">
                                        <div class="map-popup-logo user-group-popup-logo"></div>
                                        <p><strong>Location:</strong> ${group.Location}</p>
                                        ${group.Members && group.Members !== '' ? `<p><strong>Members:</strong> ${group.Members}</p>` : ''}
                                        <a href="${group.URL}" target="_blank" style="color: #a166ff;">Visit Group <i class="fas fa-external-link-alt"></i></a>
                                    </div>
                                </div>
                            `);
                            
                            markerCluster.addLayer(marker);
                        }
                    });
                    
                    // Add the marker cluster to the map
                    map.addLayer(markerCluster);
                    
                    // Initialize pagination
                    const itemsPerPage = 12;
                    let currentPage = 1;
                    let filteredGroups = [...groups];
                    
                    // Display groups with pagination
                    function displayGroups(page) {
                        const container = document.getElementById('groups-container');
                        container.innerHTML = '';
                        
                        const start = (page - 1) * itemsPerPage;
                        const end = start + itemsPerPage;
                        const paginatedGroups = filteredGroups.slice(start, end);
                        
                        paginatedGroups.forEach(group => {
                            const card = document.createElement('div');
                            card.className = 'card';
                            
                            const cardContent = document.createElement('div');
                            cardContent.className = 'card-content';
                            
                            // Add group name
                            const name = document.createElement('h3');
                            name.className = 'card-title';
                            name.textContent = group.Name;
                            cardContent.appendChild(name);
                            
                            // Add location
                            const location = document.createElement('p');
                            location.className = 'card-text';
                            location.innerHTML = `<strong>Location:</strong> ${group.Location}`;
                            cardContent.appendChild(location);
                            
                            // Add members if available
                            if (group.Members && group.Members !== '') {
                                const members = document.createElement('p');
                                members.className = 'card-text members-count';
                                members.innerHTML = `<strong>Members:</strong> ${group.Members}`;
                                cardContent.appendChild(members);
                            }
                            
                            // Add group link
                            const link = document.createElement('a');
                            link.href = group.URL;
                            link.target = '_blank';
                            link.textContent = 'Visit Group';
                            link.className = 'card-link';
                            link.innerHTML = 'Visit Group <i class="fas fa-external-link-alt"></i>';
                            cardContent.appendChild(link);
                            
                            card.appendChild(cardContent);
                            container.appendChild(card);
                        });
                        
                        updatePagination();
                    }
                    
                    // Update pagination controls
                    function updatePagination() {
                        const totalPages = Math.ceil(filteredGroups.length / itemsPerPage);
                        const paginationContainer = document.getElementById('pagination');
                        paginationContainer.innerHTML = '';
                        
                        // Previous button
                        if (totalPages > 1) {
                            const prevButton = document.createElement('button');
                            prevButton.className = 'page-btn';
                            prevButton.innerHTML = '&laquo;';
                            prevButton.disabled = currentPage === 1;
                            prevButton.addEventListener('click', () => {
                                if (currentPage > 1) {
                                    currentPage--;
                                    displayGroups(currentPage);
                                }
                            });
                            paginationContainer.appendChild(prevButton);
                        }
                        
                        // Page buttons
                        for (let i = 1; i <= totalPages; i++) {
                            if (totalPages <= 10 || 
                                i === 1 || 
                                i === totalPages || 
                                (i >= currentPage - 2 && i <= currentPage + 2)) {
                                
                                const pageButton = document.createElement('button');
                                pageButton.className = 'page-btn';
                                if (i === currentPage) {
                                    pageButton.classList.add('active');
                                }
                                pageButton.textContent = i;
                                pageButton.addEventListener('click', () => {
                                    currentPage = i;
                                    displayGroups(currentPage);
                                });
                                paginationContainer.appendChild(pageButton);
                            } else if (
                                (i === currentPage - 3 && currentPage > 3) || 
                                (i === currentPage + 3 && currentPage < totalPages - 2)
                            ) {
                                const ellipsis = document.createElement('span');
                                ellipsis.textContent = '...';
                                ellipsis.style.margin = '0 8px';
                                paginationContainer.appendChild(ellipsis);
                            }
                        }
                        
                        // Next button
                        if (totalPages > 1) {
                            const nextButton = document.createElement('button');
                            nextButton.className = 'page-btn';
                            nextButton.innerHTML = '&raquo;';
                            nextButton.disabled = currentPage === totalPages;
                            nextButton.addEventListener('click', () => {
                                if (currentPage < totalPages) {
                                    currentPage++;
                                    displayGroups(currentPage);
                                }
                            });
                            paginationContainer.appendChild(nextButton);
                        }
                    }
                    
                    // Filter groups by region
                    function filterGroups(region) {
                        if (region === 'all') {
                            filteredGroups = [...groups];
                        } else {
                            filteredGroups = groups.filter(group => {
                                // Check if the group's location includes the selected region
                                return group.Location && determineRegion(group.Location) === region;
                            });
                        }
                        
                        currentPage = 1;
                        displayGroups(currentPage);
                    }
                    
                    // Helper function to determine region from location
                    function determineRegion(location) {
                        const northAmerica = ['USA', 'United States', 'Canada', 'Mexico', 'US'];
                        const europe = ['UK', 'United Kingdom', 'Germany', 'France', 'Spain', 'Italy', 'Netherlands', 'Belgium', 'Switzerland', 'Austria', 'Sweden', 'Norway', 'Denmark', 'Finland', 'Poland', 'Ireland'];
                        const asia = ['China', 'Japan', 'India', 'Singapore', 'Malaysia', 'Indonesia', 'Thailand', 'Vietnam', 'Philippines', 'South Korea', 'Hong Kong'];
                        const southAmerica = ['Brazil', 'Argentina', 'Colombia', 'Chile', 'Peru', 'Venezuela'];
                        const africa = ['South Africa', 'Nigeria', 'Kenya', 'Egypt', 'Morocco', 'Ghana'];
                        const oceania = ['Australia', 'New Zealand', 'Fiji'];
                        
                        location = location.toLowerCase();
                        
                        if (northAmerica.some(country => location.includes(country.toLowerCase()))) {
                            return 'North America';
                        } else if (europe.some(country => location.includes(country.toLowerCase()))) {
                            return 'Europe';
                        } else if (asia.some(country => location.includes(country.toLowerCase()))) {
                            return 'Asia';
                        } else if (southAmerica.some(country => location.includes(country.toLowerCase()))) {
                            return 'South America';
                        } else if (africa.some(country => location.includes(country.toLowerCase()))) {
                            return 'Africa';
                        } else if (oceania.some(country => location.includes(country.toLowerCase()))) {
                            return 'Oceania';
                        } else {
                            return 'Unknown';
                        }
                    }
                    
                    // Search groups
                    function searchGroups(query) {
                        query = query.toLowerCase();
                        
                        filteredGroups = groups.filter(group => {
                            return (
                                group.Name.toLowerCase().includes(query) ||
                                group.Location.toLowerCase().includes(query) ||
                                (group.Category && group.Category.toLowerCase().includes(query))
                            );
                        });
                        
                        currentPage = 1;
                        displayGroups(currentPage);
                    }
                    
                    // Add event listeners to filter buttons
                    document.querySelectorAll('.filter-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            document.querySelectorAll('.filter-btn').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            this.classList.add('active');
                            filterGroups(this.dataset.category);
                        });
                    });
                    
                    // Add event listener to search input
                    document.getElementById('search-input').addEventListener('input', function() {
                        searchGroups(this.value);
                    });
                    
                    // Initial display
                    displayGroups(currentPage);
                })
                .catch(error => {
                    console.error('Error loading User Groups data:', error);
                    document.getElementById('loading').textContent = 'Error loading User Groups data. Please try again later.';
                });
            
            // Helper function to parse CSV
            function parseCSV(text) {
                const lines = text.split('\n');
                const headers = lines[0].split(',');
                
                return lines.slice(1).map(line => {
                    if (!line.trim()) return null;
                    
                    const values = line.split(',');
                    const group = {};
                    
                    headers.forEach((header, i) => {
                        group[header.trim()] = values[i] ? values[i].trim() : '';
                    });
                    
                    return group;
                }).filter(group => group !== null);
            }
        });
    </script>
</div>
{{ end }}
