{{ define "main" }}
    {{ $userGroupsCSV := "data/aws_user_groups_complete.csv" | absURL }}
    {{ $buildersCSV := "data/community_builders_complete.csv" | absURL }}
    
    <div class="content">
        <h1>{{ .Title }}</h1>
        <p>{{ .Description }}</p>
        
        {{ .Content }}
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalUserGroups">0</div>
                <div class="stat-label">User Groups</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalBuilders">0</div>
                <div class="stat-label">Community Builders</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCountries">0</div>
                <div class="stat-label">Countries</div>
            </div>
        </div>
        
        <div id="worldMap" style="height: 500px; width: 100%; border-radius: 8px; margin: 2rem 0;"></div>
        
        <div class="user-groups">
            <h2>AWS User Groups</h2>
            <p>Connect with local AWS enthusiasts through AWS User Groups in your area.</p>
            <div class="grid">
                <div class="card">
                    <h3>Find a User Group</h3>
                    <p>Join an AWS User Group to network with peers, learn from experts, and share your knowledge.</p>
                    <p><a href="{{ "user-groups" | relURL }}">Browse User Groups →</a></p>
                </div>
                <div class="card">
                    <h3>Featured User Group</h3>
                    <div id="featuredUserGroup">Loading...</div>
                </div>
            </div>
        </div>
        
        <div class="community-builders">
            <h2>AWS Community Builders</h2>
            <p>Discover content creators and technical experts in the AWS Community Builders program.</p>
            <div class="grid">
                <div class="card">
                    <h3>Meet the Builders</h3>
                    <p>Learn from AWS Community Builders who share their knowledge through blogs, videos, and more.</p>
                    <p><a href="{{ "community-builders" | relURL }}">Browse Community Builders →</a></p>
                </div>
                <div class="card">
                    <h3>Featured Community Builder</h3>
                    <div id="featuredBuilder">Loading...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Home page loaded, initializing...');
        
        // Function to parse CSV
        function parseCSV(text) {
            try {
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                return lines.slice(1)
                    .filter(line => line.trim())
                    .map(line => {
                        // Handle commas within quoted fields
                        const values = [];
                        let inQuotes = false;
                        let currentValue = '';
                        
                        for (let i = 0; i < line.length; i++) {
                            const char = line[i];
                            
                            if (char === '"') {
                                inQuotes = !inQuotes;
                            } else if (char === ',' && !inQuotes) {
                                values.push(currentValue);
                                currentValue = '';
                            } else {
                                currentValue += char;
                            }
                        }
                        
                        values.push(currentValue);
                        
                        // Create object from headers and values
                        const entry = {};
                        headers.forEach((header, i) => {
                            entry[header] = values[i] ? values[i].replace(/^"(.*)"$/, '$1') : '';
                        });
                        
                        return entry;
                    });
            } catch (e) {
                console.error('CSV parsing error:', e);
                return [];
            }
        }
        
        // Function to get coordinates for a location
        function getCoordinates(locationStr) {
            if (!locationStr) return [0, 0];
            
            // Simple hash-based coordinate generation for demo
            const hash = locationStr.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
            const lat = (hash % 140) - 70; // Range from -70 to 70
            const lng = (hash * 31 % 320) - 160; // Range from -160 to 160
            
            return [lat, lng];
        }
        
        // Initialize the map
        const map = L.map('worldMap').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Add legend
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = (map) => {
            const div = L.DomUtil.create('div', 'info legend');
            div.style.backgroundColor = 'white';
            div.style.padding = '10px';
            div.style.borderRadius = '5px';
            div.style.boxShadow = '0 1px 5px rgba(0,0,0,0.2)';
            
            div.innerHTML = `
                <div style="margin-bottom: 5px;"><strong>AWS Community</strong></div>
                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                    <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: #8C4799; margin-right: 5px;"></span>
                    <span>User Groups</span>
                </div>
                <div style="display: flex; align-items: center; margin-bottom: 5px;">
                    <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: #FF9900; margin-right: 5px;"></span>
                    <span>Community Builders</span>
                </div>
            `;
            
            return div;
        };
        legend.addTo(map);
        
        // Use the URLs generated by Hugo
        const userGroupsUrl = "{{ $userGroupsCSV }}";
        const buildersUrl = "{{ $buildersCSV }}";
        
        console.log("Loading data from:", userGroupsUrl, buildersUrl);
        
        // Load data using Promise.all
        Promise.all([
            fetch(userGroupsUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.text();
                }),
            fetch(buildersUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.text();
                })
        ])
        .then(([userGroupsText, buildersText]) => {
            // Parse CSV data
            const userGroups = parseCSV(userGroupsText);
            const builders = parseCSV(buildersText);
            
            console.log(`Loaded ${userGroups.length} user groups and ${builders.length} community builders`);
            
            // Update stats
            document.getElementById('totalUserGroups').textContent = userGroups.length;
            document.getElementById('totalBuilders').textContent = builders.length;
            
            // Count unique countries
            const countries = new Set();
            userGroups.forEach(group => {
                if (group.Location) {
                    const country = group.Location.split(',').pop().trim();
                    if (country) countries.add(country);
                }
            });
            
            builders.forEach(builder => {
                if (builder.Location) {
                    const country = builder.Location.split(',').pop().trim();
                    if (country) countries.add(country);
                }
            });
            
            document.getElementById('totalCountries').textContent = countries.size;
            
            // Group by country
            const countryData = {};
            
            function addToCountryData(item, type) {
                if (!item.Location) return;
                
                const country = item.Location.split(',').pop().trim();
                if (!country) return;
                
                if (!countryData[country]) {
                    countryData[country] = { userGroups: 0, builders: 0 };
                }
                countryData[country][type]++;
            }
            
            userGroups.forEach(group => addToCountryData(group, 'userGroups'));
            builders.forEach(builder => addToCountryData(builder, 'builders'));
            
            // Add markers for each country
            Object.entries(countryData).forEach(([country, data]) => {
                const coords = getCoordinates(country);
                
                // User groups marker
                if (data.userGroups > 0) {
                    const ugMarker = L.circleMarker([coords[0] - 0.5, coords[1] - 0.5], {
                        radius: Math.min(Math.max(Math.sqrt(data.userGroups) * 3, 8), 20),
                        fillColor: '#8C4799', // AWS Purple
                        color: '#fff',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    ugMarker.bindPopup(`
                        <div class="map-popup">
                            <h3>${country}</h3>
                            <p><strong>${data.userGroups}</strong> User Groups</p>
                        </div>
                    `);
                }
                
                // Community builders marker
                if (data.builders > 0) {
                    const cbMarker = L.circleMarker([coords[0] + 0.5, coords[1] + 0.5], {
                        radius: Math.min(Math.max(Math.sqrt(data.builders) * 3, 8), 20),
                        fillColor: '#FF9900', // AWS Orange
                        color: '#fff',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    
                    cbMarker.bindPopup(`
                        <div class="map-popup">
                            <h3>${country}</h3>
                            <p><strong>${data.builders}</strong> Community Builders</p>
                        </div>
                    `);
                }
            });
            
            // Featured User Group
            if (userGroups.length > 0) {
                const randomGroupIndex = Math.floor(Math.random() * userGroups.length);
                const featuredGroup = userGroups[randomGroupIndex];
                
                document.getElementById('featuredUserGroup').innerHTML = `
                    <h4>${featuredGroup.Name || 'Unknown Group'}</h4>
                    <p><strong>Location:</strong> ${featuredGroup.Location || 'Unknown Location'}</p>
                    <p><a href="${featuredGroup.URL || '#'}" target="_blank">Visit Group →</a></p>
                `;
            } else {
                document.getElementById('featuredUserGroup').innerHTML = '<p>No user groups available</p>';
            }
            
            // Featured Community Builder
            if (builders.length > 0) {
                const randomBuilderIndex = Math.floor(Math.random() * builders.length);
                const featuredBuilder = builders[randomBuilderIndex];
                
                let bioLink = '';
                if (featuredBuilder['Bio URL'] && featuredBuilder['Bio URL'] !== 'No URL') {
                    bioLink = `<p><a href="${featuredBuilder['Bio URL']}" target="_blank">View Profile →</a></p>`;
                }
                
                document.getElementById('featuredBuilder').innerHTML = `
                    <h4>${featuredBuilder.Name || 'Unknown Builder'}</h4>
                    <p><strong>Location:</strong> ${featuredBuilder.Location || 'Unknown Location'}</p>
                    <p><strong>Category:</strong> ${featuredBuilder.Category || 'Unknown Category'}</p>
                    ${bioLink}
                `;
            } else {
                document.getElementById('featuredBuilder').innerHTML = '<p>No community builders available</p>';
            }
        })
        .catch(error => {
            console.error('Error loading data:', error);
            
            // Fallback to hardcoded data for demonstration
            console.log('Falling back to hardcoded data');
            
            // Update stats with fallback data
            document.getElementById('totalUserGroups').textContent = '300+';
            document.getElementById('totalBuilders').textContent = '600+';
            document.getElementById('totalCountries').textContent = '50+';
            
            // Add some fallback markers to the map
            const fallbackCountries = [
                { name: 'United States', coords: [37.0902, -95.7129], userGroups: 50, builders: 120 },
                { name: 'Germany', coords: [51.1657, 10.4515], userGroups: 25, builders: 40 },
                { name: 'India', coords: [20.5937, 78.9629], userGroups: 30, builders: 80 },
                { name: 'Brazil', coords: [-14.2350, -51.9253], userGroups: 15, builders: 30 },
                { name: 'Australia', coords: [-25.2744, 133.7751], userGroups: 10, builders: 25 },
                { name: 'Japan', coords: [36.2048, 138.2529], userGroups: 8, builders: 20 },
                { name: 'United Kingdom', coords: [55.3781, -3.4360], userGroups: 20, builders: 45 }
            ];
            
            fallbackCountries.forEach(country => {
                // User groups marker
                const ugMarker = L.circleMarker([country.coords[0] - 0.5, country.coords[1] - 0.5], {
                    radius: Math.min(Math.max(Math.sqrt(country.userGroups) * 3, 8), 20),
                    fillColor: '#8C4799', // AWS Purple
                    color: '#fff',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
                
                ugMarker.bindPopup(`
                    <div class="map-popup">
                        <h3>${country.name}</h3>
                        <p><strong>${country.userGroups}</strong> User Groups</p>
                    </div>
                `);
                
                // Community builders marker
                const cbMarker = L.circleMarker([country.coords[0] + 0.5, country.coords[1] + 0.5], {
                    radius: Math.min(Math.max(Math.sqrt(country.builders) * 3, 8), 20),
                    fillColor: '#FF9900', // AWS Orange
                    color: '#fff',
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
                
                cbMarker.bindPopup(`
                    <div class="map-popup">
                        <h3>${country.name}</h3>
                        <p><strong>${country.builders}</strong> Community Builders</p>
                    </div>
                `);
            });
            
            // Featured User Group
            document.getElementById('featuredUserGroup').innerHTML = `
                <h4>AWS User Group Berlin</h4>
                <p><strong>Location:</strong> Berlin, Germany</p>
                <p><a href="#" target="_blank">Visit Group →</a></p>
            `;
            
            // Featured Community Builder
            document.getElementById('featuredBuilder').innerHTML = `
                <h4>Jane Smith</h4>
                <p><strong>Location:</strong> Seattle, USA</p>
                <p><strong>Category:</strong> Serverless Builder since 2022</p>
                <p><a href="#" target="_blank">View Profile →</a></p>
            `;
        });
    });
    </script>
{{ end }}
