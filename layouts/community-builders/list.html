{{ define "main" }}
<div class="community-builders-page">
    {{ .Content }}
    
    <h1>AWS Community Builders</h1>
    
    <div id="map" style="height: 500px;"></div>
    
    <div class="search-container">
        <input type="text" id="search-input" class="search-input" placeholder="Search by name, location, or category...">
        
        <div class="filters">
            <button class="filter-btn active" data-category="all">All Categories</button>
            <button class="filter-btn" data-category="Serverless">Serverless</button>
            <button class="filter-btn" data-category="Containers">Containers</button>
            <button class="filter-btn" data-category="Machine Learning">Machine Learning</button>
            <button class="filter-btn" data-category="Data">Data</button>
            <button class="filter-btn" data-category="DevOps">DevOps</button>
            <button class="filter-btn" data-category="Security">Security</button>
            <button class="filter-btn" data-category="Networking">Networking</button>
            <button class="filter-btn" data-category="Storage">Storage</button>
            <button class="filter-btn" data-category="Front-end Web & Mobile">Front-end Web & Mobile</button>
        </div>
    </div>
    
    <div id="builders-container" class="grid"></div>
    
    <div class="pagination" id="pagination"></div>
    
    <div id="loading" class="loading">
        <i class="fas fa-spinner fa-spin"></i> Loading Community Builders...
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the map
            const map = L.map('map').setView([20, 0], 2);
            
            // Add the tile layer (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Custom blue icon for markers
            const blueIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
            
            // Use the CSV URL directly
            const buildersCSV = "/data/aws_community_builders.csv?v=" + new Date().getTime();
            console.log("Loading AWS Community Builders from:", buildersCSV);
            
            // Load community builders data
            fetch(buildersCSV)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(csvText => {
                    // Parse CSV
                    const builders = parseCSV(csvText);
                    
                    // Hide loading indicator
                    document.getElementById('loading').style.display = 'none';
                    
                    // Create marker cluster group
                    const markerCluster = L.markerClusterGroup({
                        maxClusterRadius: 50,
                        spiderfyOnMaxZoom: true,
                        showCoverageOnHover: true,
                        zoomToBoundsOnClick: true,
                        iconCreateFunction: function(cluster) {
                            const count = cluster.getChildCount();
                            // Calculate color intensity based on count
                            let color;
                            if (count < 10) {
                                color = '#1A73E8'; // Light blue
                            } else if (count < 25) {
                                color = '#1565C0'; // Medium blue
                            } else if (count < 50) {
                                color = '#0D47A1'; // Darker blue
                            } else {
                                color = '#002171'; // Very dark blue
                            }
                            
                            return L.divIcon({
                                html: `<div style="background-color: ${color}; color: white; border-radius: 50%; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-weight: bold;">${count}</div>`,
                                className: 'marker-cluster',
                                iconSize: L.point(40, 40)
                            });
                        }
                    });
                    
                    // Add markers to the cluster
                    builders.forEach(builder => {
                        if (builder.Latitude && builder.Longitude) {
                            const marker = L.marker([builder.Latitude, builder.Longitude], { icon: blueIcon });
                            
                            marker.bindPopup(`
                                <div class="map-popup">
                                    <div class="map-popup-header builder-popup-header">
                                        <h3>${builder.Name}</h3>
                                    </div>
                                    <div class="map-popup-content">
                                        <div class="map-popup-logo builder-popup-logo"></div>
                                        <p><strong>Location:</strong> ${builder.Location}</p>
                                        <p><strong>Category:</strong> ${builder.Category}</p>
                                        <a href="${builder.BioURL}" target="_blank" style="color: #1A73E8;">View Profile <i class="fas fa-external-link-alt"></i></a>
                                    </div>
                                </div>
                            `);
                            
                            markerCluster.addLayer(marker);
                        }
                    });
                    
                    // Add the marker cluster to the map
                    map.addLayer(markerCluster);
                    
                    // Initialize pagination
                    const itemsPerPage = 12;
                    let currentPage = 1;
                    let filteredBuilders = [...builders];
                    
                    // Display builders with pagination
                    function displayBuilders(page) {
                        const container = document.getElementById('builders-container');
                        container.innerHTML = '';
                        
                        const start = (page - 1) * itemsPerPage;
                        const end = start + itemsPerPage;
                        const paginatedBuilders = filteredBuilders.slice(start, end);
                        
                        paginatedBuilders.forEach(builder => {
                            const card = document.createElement('div');
                            card.className = 'card';
                            
                            const cardContent = document.createElement('div');
                            cardContent.className = 'card-content';
                            
                            // Add builder name
                            const name = document.createElement('h3');
                            name.className = 'card-title';
                            name.textContent = builder.Name;
                            cardContent.appendChild(name);
                            
                            // Add location
                            const location = document.createElement('p');
                            location.className = 'card-text';
                            location.innerHTML = `<strong>Location:</strong> ${builder.Location}`;
                            cardContent.appendChild(location);
                            
                            // Add category
                            const category = document.createElement('p');
                            category.className = 'card-text';
                            category.innerHTML = `<strong>Category:</strong> ${builder.Category}`;
                            cardContent.appendChild(category);
                            
                            // Add profile link
                            const link = document.createElement('a');
                            link.href = builder.BioURL;
                            link.target = '_blank';
                            link.className = 'card-link';
                            link.innerHTML = 'View Profile <i class="fas fa-external-link-alt"></i>';
                            cardContent.appendChild(link);
                            
                            card.appendChild(cardContent);
                            container.appendChild(card);
                        });
                        
                        updatePagination();
                    }
                    
                    // Update pagination controls
                    function updatePagination() {
                        const totalPages = Math.ceil(filteredBuilders.length / itemsPerPage);
                        const paginationContainer = document.getElementById('pagination');
                        paginationContainer.innerHTML = '';
                        
                        // Previous button
                        if (totalPages > 1) {
                            const prevButton = document.createElement('button');
                            prevButton.className = 'page-btn';
                            prevButton.innerHTML = '&laquo;';
                            prevButton.disabled = currentPage === 1;
                            prevButton.addEventListener('click', () => {
                                if (currentPage > 1) {
                                    currentPage--;
                                    displayBuilders(currentPage);
                                }
                            });
                            paginationContainer.appendChild(prevButton);
                        }
                        
                        // Page buttons
                        for (let i = 1; i <= totalPages; i++) {
                            if (totalPages <= 10 || 
                                i === 1 || 
                                i === totalPages || 
                                (i >= currentPage - 2 && i <= currentPage + 2)) {
                                
                                const pageButton = document.createElement('button');
                                pageButton.className = 'page-btn';
                                if (i === currentPage) {
                                    pageButton.classList.add('active');
                                }
                                pageButton.textContent = i;
                                pageButton.addEventListener('click', () => {
                                    currentPage = i;
                                    displayBuilders(currentPage);
                                });
                                paginationContainer.appendChild(pageButton);
                            } else if (
                                (i === currentPage - 3 && currentPage > 3) || 
                                (i === currentPage + 3 && currentPage < totalPages - 2)
                            ) {
                                const ellipsis = document.createElement('span');
                                ellipsis.textContent = '...';
                                ellipsis.style.margin = '0 8px';
                                paginationContainer.appendChild(ellipsis);
                            }
                        }
                        
                        // Next button
                        if (totalPages > 1) {
                            const nextButton = document.createElement('button');
                            nextButton.className = 'page-btn';
                            nextButton.innerHTML = '&raquo;';
                            nextButton.disabled = currentPage === totalPages;
                            nextButton.addEventListener('click', () => {
                                if (currentPage < totalPages) {
                                    currentPage++;
                                    displayBuilders(currentPage);
                                }
                            });
                            paginationContainer.appendChild(nextButton);
                        }
                    }
                    
                    // Filter builders by category
                    function filterBuilders(category) {
                        if (category === 'all') {
                            filteredBuilders = [...builders];
                        } else {
                            filteredBuilders = builders.filter(builder => {
                                // Check if the builder's category includes the selected category
                                return builder.Category && builder.Category.includes(category);
                            });
                        }
                        
                        currentPage = 1;
                        displayBuilders(currentPage);
                    }
                    
                    // Search builders
                    function searchBuilders(query) {
                        query = query.toLowerCase();
                        
                        filteredBuilders = builders.filter(builder => {
                            return (
                                builder.Name.toLowerCase().includes(query) ||
                                builder.Location.toLowerCase().includes(query) ||
                                (builder.Category && builder.Category.toLowerCase().includes(query))
                            );
                        });
                        
                        currentPage = 1;
                        displayBuilders(currentPage);
                    }
                    
                    // Add event listeners to filter buttons
                    document.querySelectorAll('.filter-btn').forEach(button => {
                        button.addEventListener('click', function() {
                            document.querySelectorAll('.filter-btn').forEach(btn => {
                                btn.classList.remove('active');
                            });
                            this.classList.add('active');
                            filterBuilders(this.dataset.category);
                        });
                    });
                    
                    // Add event listener to search input
                    document.getElementById('search-input').addEventListener('input', function() {
                        searchBuilders(this.value);
                    });
                    
                    // Special handling for Machine Learning filter
                    document.querySelector('.filter-btn[data-category="Machine Learning"]').addEventListener('click', function() {
                        document.querySelectorAll('.filter-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        this.classList.add('active');
                        
                        // First try to filter by exact category match
                        let mlBuilders = builders.filter(builder => 
                            builder.Category && builder.Category.includes("Machine Learning")
                        );
                        
                        // If no results, try broader search for ML, AI, etc.
                        if (mlBuilders.length === 0) {
                            mlBuilders = builders.filter(builder => 
                                builder.Category && (
                                    builder.Category.includes("ML") || 
                                    builder.Category.includes("AI") || 
                                    builder.Category.toLowerCase().includes("machine") || 
                                    builder.Category.toLowerCase().includes("learning") || 
                                    builder.Category.toLowerCase().includes("artificial")
                                )
                            );
                        }
                        
                        filteredBuilders = mlBuilders;
                        currentPage = 1;
                        displayBuilders(currentPage);
                    });
                    
                    // Initial display
                    displayBuilders(currentPage);
                })
                .catch(error => {
                    console.error('Error loading Community Builders data:', error);
                    document.getElementById('loading').textContent = 'Error loading Community Builders data. Please try again later.';
                });
            
            // Helper function to parse CSV
            function parseCSV(text) {
                const lines = text.split('\n');
                const headers = lines[0].split(',');
                
                return lines.slice(1).map(line => {
                    if (!line.trim()) return null;
                    
                    const values = line.split(',');
                    const builder = {};
                    
                    headers.forEach((header, i) => {
                        builder[header.trim()] = values[i] ? values[i].trim() : '';
                    });
                    
                    return builder;
                }).filter(builder => builder !== null);
            }
        });
    </script>
</div>
{{ end }}
